package engine.agent;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import interfaces.NCCutConveyor;
import interfaces.StockPileRobot;
import shared.Glass;
import transducer.TChannel;
import transducer.TEvent;
import transducer.TReceiver;
import transducer.Transducer;

public class StockPileRobotAgent extends Agent implements TReceiver, StockPileRobot{

	//Data:
	public List<RobotGlass> glassPile;
	public enum RobotState {IDLE, ANIMATED};
	public enum GlassState {PENDING, CONVEYOR_NOTIFIED, PASSING_TO_CONVEYOR, GIVING_TO_CONVEYOR, PASSED_TO_CONVEYOR};
	private NCCutConveyor conveyor;
	RobotState state;
	
	// for gui control
	public int myIndex;

	public class RobotGlass{

		public GlassState state; // current state of glass

		Glass glass; // reference to the glassobject
		
		public RobotGlass(Glass g){
			this.state = GlassState.PENDING;
			this.glass = g;
		}

	}


	Transducer trans; // to talk to gui

	public StockPileRobotAgent(Transducer t, String myName) {
		super(myName);
		trans = t;
		trans.register(this, TChannel.BIN);
		trans.register(this, TChannel.ALL_AGENTS);
		glassPile = Collections.synchronizedList(new ArrayList<RobotGlass>());
		state = RobotState.IDLE;
	}
	
	//Messages:

	/* (non-Javadoc)
	 * @see StartOfFactory.StockPileRobot#msgAddToStockPile(StartOfFactory.Glass)
	 */
	@Override
	public void msgAddToStockPile(Glass glass) 
	{ 
		this.Do(this.getName() + " has received message to add " + glass.toString() + " to stockpile.");
		synchronized(glassPile){
			glassPile.add(new RobotGlass(glass)); 
		}
		
		for(int i = 0; i < glass.getOperationsToPerform().size(); i++) {
			System.out.println("OPERATIONS GLASS PERFORMS:   " + glass.getOperationsToPerform().get(i) + "      BBC");
		}
		//Object[] args = new Object[1];
		//args[0] = glass.getGuiGlass();
		//trans.fireEvent(TChannel.BIN, TEvent.BIN_CREATE_PART, args);
		stateChanged();
	} //can add random generated number (0 or 1) to put in left or right bin

	/* (non-Javadoc)
	 * @see StartOfFactory.StockPileRobot#msgIAmReadyForGlass()
	 */
	@Override
	public void msgIAmReadyForGlass() { 
		this.Do(this.getName() + " has received message that conveyor is ready for glass.");
		//only change the first glass to have state CONVEYOR_NOTIFIED
		RobotGlass g = findGlassByState(GlassState.CONVEYOR_NOTIFIED);
		if(g != null){
			synchronized(glassPile){
				g.state = GlassState.PASSING_TO_CONVEYOR;
			}
			this.Do(this.getName() + " is setting state of " + g.glass.toString() + " to PASSING_TO_CONVEYOR.");
			stateChanged();
		}
	}

	 //Scheduler:
	public boolean pickAndExecuteAnAction(){
		RobotGlass glass;
		glass = findGlassByState(GlassState.PENDING);
		if(glass != null)
		{
			askConveyor(glass);
			return true;
		}
		glass = findGlassByState(GlassState.PASSING_TO_CONVEYOR);
		if(glass != null)
		{
			giveGlassToConveyor(glass);
			return true;
		}
		glass = findGlassByState(GlassState.PASSED_TO_CONVEYOR);
		if(glass != null)
		{
			removeGlass(glass);
			return true;
		}

		return false;
	}

	//Actions:
	public void askConveyor(RobotGlass glass) {
		this.Do(" sending message to " + conveyor.toString() + " that it has " + glass.glass.toString() + " to pass.");
		conveyor.msgIHaveGlass();
		synchronized(glassPile){
			glass.state = GlassState.CONVEYOR_NOTIFIED;
		}
		stateChanged();
	}

	public void giveGlassToConveyor(RobotGlass g) {
		// do gui
		// can check for left or right bin here and select appropriate bin
		state = RobotState.ANIMATED;
		// done with gui
		this.Do(this.getName() + " is passing " + g.glass.toString() + " to " + conveyor.toString() + ".");
		synchronized(glassPile)
		{
			g.state = GlassState.GIVING_TO_CONVEYOR;
		}
		//Object[] args = new Object[1];
		//args[0] = g.glass.getGuiGlass();
		//this.Do("The args that are getting passed are.... " + args2[0].toString() + " the gui glass is " + g.glass.getGuiGlass().toString());
		//this.Do("DO THEY MATCH?   " + args2[0].equals(g.glass.getGuiGlass()));
		trans.fireEvent(TChannel.BIN, TEvent.BIN_CREATE_PART, null);
		stateChanged();
	}
	
	public void removeGlass(RobotGlass glass) {
		conveyor.msgHereIsGlass(glass.glass);
		synchronized(glassPile){
			glassPile.remove(glass);
		}
		stateChanged();
	}

	//Helper Functions
	public RobotGlass findGlassByState(GlassState state){
		synchronized(glassPile)
		{
			for(RobotGlass g:glassPile){
				if(g.state == state)
					return g;
			}
		}
		return null;
	}
	
	public void setMyIndex(int index)
	{
		this.myIndex = index;
	}

	/* (non-Javadoc)
	 * @see StartOfFactory.StockPileRobot#setPopup(StartOfFactory.NCPopupAgent)
	 */
	@Override
	public void setConveyor(NCCutConveyor conveyor)
	{
		this.conveyor = conveyor;
	}
	
	
	
	@Override
	public void eventFired(TChannel channel, TEvent event, Object[] args) {
		// gui animation is finished
		/*if(event == TEvent.BIN_CREATE_PART)
		{
			this.msgAddToStockPile((AgentGlass)args[0]);
		}*/
		if(event == TEvent.BIN_PART_CREATED && state == RobotState.ANIMATED){
			RobotGlass g = findGlassByState(GlassState.GIVING_TO_CONVEYOR);
			if(g!= null)
			{
				state = RobotState.IDLE;
				synchronized(glassPile){
					g.state = GlassState.PASSED_TO_CONVEYOR;
				}
				stateChanged();
			}
		}
		
		
	}
	public void setState(RobotState state) {
		this.state = state;
	}

	public RobotState getState() {
		return state;
	}
	public String toString()
	{
		return this.getName();
	}
}
